<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroFinance Kenya - Sign Up</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --border-color: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(to right, var(--dark-color), var(--primary-color));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--secondary-color);
        }

        .logo h1 {
            font-size: 2rem;
            font-weight: 700;
        }

        .logo span {
            color: var(--secondary-color);
            font-weight: 300;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .signup-form {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-color);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .password-wrapper {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--dark-color);
            cursor: pointer;
            font-size: 1.1rem;
        }

        .role-info {
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--dark-color);
        }

        .role-info i {
            color: var(--primary-color);
            margin-right: 8px;
        }

        .county-selection {
            display: none;
        }

        .county-selection.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-actions {
            margin-top: 30px;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
        }

        .btn-google {
            background: white;
            color: var(--dark-color);
            border: 2px solid var(--border-color);
            margin-top: 15px;
        }

        .btn-google:hover {
            background: #f8fafc;
        }

        .divider {
            text-align: center;
            margin: 25px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border-color);
        }

        .divider span {
            background: white;
            padding: 0 15px;
            color: var(--dark-color);
            font-size: 0.9rem;
        }

        .login-link {
            text-align: center;
            margin-top: 20px;
            color: var(--dark-color);
        }

        .login-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .login-link a:hover {
            text-decoration: underline;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--secondary-color);
        }

        .alert-warning {
            background-color: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning-color);
        }

        .alert-danger {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger-color);
        }

        .approval-message {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .county-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .county-option {
            padding: 8px 12px;
            background: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .county-option:hover {
            background: var(--primary-color);
            color: white;
        }

        .county-option.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        @media (max-width: 576px) {
            .container {
                max-width: 100%;
            }
            
            .header, .signup-form {
                padding: 20px;
            }
            
            .logo h1 {
                font-size: 1.8rem;
            }
            
            .county-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-coins"></i>
                <h1>MicroFinance<span>Kenya</span></h1>
            </div>
            <p>National Microfinance Management System</p>
        </div>

        <div class="signup-form">
            <div id="alert" class="alert"></div>
            
            <form id="signupForm">
                <div class="form-group">
                    <label for="fullName"><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" id="fullName" required placeholder="Enter your full name">
                </div>

                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="email" required placeholder="Enter your email">
                </div>

                <div class="form-group">
                    <label for="phone"><i class="fas fa-phone"></i> Phone Number</label>
                    <input type="tel" id="phone" required placeholder="+2547XXXXXXXX">
                </div>

                <div class="form-group">
                    <label for="nationalId"><i class="fas fa-id-card"></i> National ID Number</label>
                    <input type="text" id="nationalId" required placeholder="Enter national ID">
                </div>

                <div class="form-group">
                    <label for="role"><i class="fas fa-user-tag"></i> Role</label>
                    <select id="role" required>
                        <option value="">Select Role</option>
                        <option value="admin">Administrator</option>
                        <option value="finance">Finance Officer</option>
                        <option value="manager">County Manager</option>
                    </select>
                </div>

                <div id="countySelection" class="county-selection">
                    <div class="form-group">
                        <label for="county"><i class="fas fa-map-marker-alt"></i> Assigned County</label>
                        <div class="county-grid" id="countyGrid">
                            <!-- Counties will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" required placeholder="Create a strong password" minlength="8">
                        <button type="button" class="toggle-password" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword"><i class="fas fa-lock"></i> Confirm Password</label>
                    <input type="password" id="confirmPassword" required placeholder="Confirm your password">
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="signupBtn">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>

                    <div class="divider">
                        <span>Or sign up with</span>
                    </div>

                    <button type="button" class="btn btn-google" id="googleSignup">
                        <i class="fab fa-google"></i> Google
                    </button>
                </div>
            </form>

            <div class="login-link">
                Already have an account? <a href="login.html">Sign In</a>
            </div>

            <div id="approvalMessage" class="approval-message">
                <i class="fas fa-clock"></i>
                <h3>Waiting for Admin Approval</h3>
                <p>Your account is pending approval from the system administrator.</p>
                <div class="approval-timer">
                    <div class="timer-bar">
                        <div class="timer-progress"></div>
                    </div>
                    <p id="timerText">Approval in progress...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Kenyan counties
        const kenyanCounties = [
            'Mombasa', 'Kwale', 'Kilifi', 'Tana River', 'Lamu', 'Taita Taveta', 'Garissa',
            'Wajir', 'Mandera', 'Marsabit', 'Isiolo', 'Meru', 'Tharaka Nithi', 'Embu',
            'Kitui', 'Machakos', 'Makueni', 'Nyandarua', 'Nyeri', 'Kirinyaga', 'Muranga',
            'Kiambu', 'Turkana', 'West Pokot', 'Samburu', 'Trans Nzoia', 'Uasin Gishu',
            'Elgeyo Marakwet', 'Nandi', 'Baringo', 'Laikipia', 'Nakuru', 'Narok', 'Kajiado',
            'Kericho', 'Bomet', 'Kakamega', 'Vihiga', 'Bungoma', 'Busia', 'Siaya',
            'Kisumu', 'Homa Bay', 'Migori', 'Kisii', 'Nyamira', 'Nairobi City'
        ];

        class SignupSystem {
            constructor() {
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.populateCounties();
                this.checkExistingUsers();
            }

            setupEventListeners() {
                // Role change listener
                document.getElementById('role').addEventListener('change', (e) => {
                    this.handleRoleChange(e.target.value);
                });

                // Password toggle
                document.getElementById('togglePassword').addEventListener('click', () => {
                    this.togglePasswordVisibility();
                });

                // Form submission
                document.getElementById('signupForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSignup();
                });

                // Google signup
                document.getElementById('googleSignup').addEventListener('click', () => {
                    this.handleGoogleSignup();
                });
            }

            populateCounties() {
                const countyGrid = document.getElementById('countyGrid');
                countyGrid.innerHTML = '';
                
                kenyanCounties.forEach(county => {
                    const option = document.createElement('div');
                    option.className = 'county-option';
                    option.textContent = county;
                    option.dataset.county = county.toLowerCase().replace(/ /g, '-');
                    
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.county-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        option.classList.add('selected');
                    });
                    
                    countyGrid.appendChild(option);
                });
            }

            checkExistingUsers() {
                const users = JSON.parse(localStorage.getItem('mfk_users') || '[]');
                
                // Check if admin already exists
                const adminExists = users.some(user => user.role === 'admin');
                if (adminExists) {
                    const roleSelect = document.getElementById('role');
                    const adminOption = roleSelect.querySelector('option[value="admin"]');
                    if (adminOption) {
                        adminOption.disabled = true;
                        adminOption.textContent = 'Administrator (Already exists)';
                    }
                }
                
                // Check if finance officer exists
                const financeExists = users.some(user => user.role === 'finance');
                if (financeExists) {
                    const roleSelect = document.getElementById('role');
                    const financeOption = roleSelect.querySelector('option[value="finance"]');
                    if (financeOption) {
                        financeOption.disabled = true;
                        financeOption.textContent = 'Finance Officer (Already exists)';
                    }
                }
                
                // Count existing managers
                const managerCount = users.filter(user => user.role === 'manager').length;
                if (managerCount >= 47) {
                    const roleSelect = document.getElementById('role');
                    const managerOption = roleSelect.querySelector('option[value="manager"]');
                    if (managerOption) {
                        managerOption.disabled = true;
                        managerOption.textContent = 'County Manager (Maximum reached)';
                    }
                }
            }

            handleRoleChange(role) {
                const countySelection = document.getElementById('countySelection');
                
                if (role === 'manager') {
                    countySelection.classList.add('active');
                } else {
                    countySelection.classList.remove('active');
                }
            }

            togglePasswordVisibility() {
                const passwordInput = document.getElementById('password');
                const toggleBtn = document.getElementById('togglePassword');
                const icon = toggleBtn.querySelector('i');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    passwordInput.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            }

            async handleSignup() {
                // Get form values
                const fullName = document.getElementById('fullName').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const nationalId = document.getElementById('nationalId').value.trim();
                const role = document.getElementById('role').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Validation
                if (!this.validateForm()) {
                    return;
                }

                // Check if admin already exists
                const users = JSON.parse(localStorage.getItem('mfk_users') || '[]');
                
                if (role === 'admin') {
                    const adminExists = users.some(user => user.role === 'admin');
                    if (adminExists) {
                        this.showAlert('Administrator account already exists. Only one admin is allowed.', 'danger');
                        return;
                    }
                }
                
                if (role === 'finance') {
                    const financeExists = users.some(user => user.role === 'finance');
                    if (financeExists) {
                        this.showAlert('Finance officer account already exists. Only one finance officer is allowed.', 'danger');
                        return;
                    }
                }
                
                if (role === 'manager') {
                    const managerCount = users.filter(user => user.role === 'manager').length;
                    if (managerCount >= 47) {
                        this.showAlert('Maximum number of county managers (47) reached.', 'danger');
                        return;
                    }
                    
                    // Check if county is selected
                    const selectedCounty = document.querySelector('.county-option.selected');
                    if (!selectedCounty) {
                        this.showAlert('Please select a county for the manager role.', 'danger');
                        return;
                    }
                }

                // Show loading state
                const signupBtn = document.getElementById('signupBtn');
                const originalText = signupBtn.innerHTML;
                signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
                signupBtn.disabled = true;

                try {
                    // Simulate API call
                    await this.simulateApiCall();
                    
                    // Create user object
                    const user = {
                        id: 'user_' + Date.now(),
                        fullName,
                        email,
                        phone,
                        nationalId,
                        role,
                        password: btoa(password), // Simple encoding for demo
                        status: role === 'admin' ? 'approved' : 'pending',
                        createdAt: new Date().toISOString(),
                        county: role === 'manager' ? document.querySelector('.county-option.selected').textContent : null
                    };

                    // Save to local storage
                    users.push(user);
                    localStorage.setItem('mfk_users', JSON.stringify(users));
                    
                    // Save current user session
                    localStorage.setItem('mfk_current_user', JSON.stringify({
                        id: user.id,
                        fullName: user.fullName,
                        role: user.role,
                        status: user.status
                    }));

                    if (role === 'admin') {
                        // Admin gets immediate access
                        this.showAlert('Admin account created successfully! Redirecting to dashboard...', 'success');
                        setTimeout(() => {
                            window.location.href = 'admin.html';
                        }, 1500);
                    } else {
                        // Show approval message for non-admin roles
                        this.showApprovalProcess(user);
                    }

                } catch (error) {
                    this.showAlert(error.message, 'danger');
                    signupBtn.innerHTML = originalText;
                    signupBtn.disabled = false;
                }
            }

            validateForm() {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const nationalId = document.getElementById('nationalId').value.trim();
                const phone = document.getElementById('phone').value.trim();

                // Password match validation
                if (password !== confirmPassword) {
                    this.showAlert('Passwords do not match.', 'danger');
                    return false;
                }

                // Password strength validation
                if (password.length < 8) {
                    this.showAlert('Password must be at least 8 characters long.', 'danger');
                    return false;
                }

                // National ID validation (Kenyan ID format)
                if (!/^\d{8}$/.test(nationalId)) {
                    this.showAlert('National ID must be 8 digits.', 'danger');
                    return false;
                }

                // Phone validation (Kenyan format)
                if (!/^\+2547\d{8}$/.test(phone)) {
                    this.showAlert('Phone number must be in format +2547XXXXXXXX.', 'danger');
                    return false;
                }

                return true;
            }

            async simulateApiCall() {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({ success: true });
                    }, 1000);
                });
            }

            showApprovalProcess(user) {
                // Hide form
                document.getElementById('signupForm').style.display = 'none';
                
                // Show approval message
                const approvalMessage = document.getElementById('approvalMessage');
                approvalMessage.style.display = 'block';
                
                // Start approval simulation
                this.simulateAdminApproval(user);
            }

            simulateAdminApproval(user) {
                let seconds = 10;
                const timerText = document.getElementById('timerText');
                const timerProgress = document.querySelector('.timer-progress');
                
                const timer = setInterval(() => {
                    seconds--;
                    timerText.textContent = `Waiting for admin approval... ${seconds}s`;
                    timerProgress.style.width = `${(10 - seconds) * 10}%`;
                    
                    if (seconds <= 0) {
                        clearInterval(timer);
                        
                        // Update user status to approved
                        const users = JSON.parse(localStorage.getItem('mfk_users') || '[]');
                        const userIndex = users.findIndex(u => u.id === user.id);
                        if (userIndex !== -1) {
                            users[userIndex].status = 'approved';
                            localStorage.setItem('mfk_users', JSON.stringify(users));
                        }
                        
                        // Update approval message
                        timerText.textContent = 'Approved! Redirecting to login...';
                        timerProgress.style.width = '100%';
                        timerProgress.style.backgroundColor = '#10b981';
                        
                        // Redirect to login after approval
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    }
                }, 1000);
            }

            handleGoogleSignup() {
                // Initialize Google Sign-In
                if (typeof google !== 'undefined') {
                    google.accounts.id.initialize({
                        client_id: 'YOUR_GOOGLE_CLIENT_ID', // Replace with your actual client ID
                        callback: this.handleGoogleResponse.bind(this),
                        context: 'signup'
                    });
                    
                    google.accounts.id.prompt();
                } else {
                    this.showAlert('Google Sign-In is not available. Please use the form.', 'warning');
                }
            }

            handleGoogleResponse(response) {
                try {
                    const profile = JSON.parse(atob(response.credential.split('.')[1]));
                    
                    // Pre-fill form with Google data
                    document.getElementById('fullName').value = profile.name;
                    document.getElementById('email').value = profile.email;
                    
                    this.showAlert('Google account connected. Please complete the form.', 'success');
                } catch (error) {
                    this.showAlert('Failed to process Google Sign-In.', 'danger');
                }
            }

            showAlert(message, type) {
                const alert = document.getElementById('alert');
                alert.textContent = message;
                alert.className = `alert alert-${type}`;
                alert.style.display = 'block';
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize signup system
        document.addEventListener('DOMContentLoaded', () => {
            window.signupSystem = new SignupSystem();
        });
    </script>
</body>
</html>