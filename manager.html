<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>County Manager Dashboard - MicroFinance Kenya</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #8b5cf6;
            
            --bg-color: #f8fafc;
            --sidebar-bg: #1e293b;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            
            --success-bg: #d1fae5;
            --success-text: #065f46;
            --warning-bg: #fef3c7;
            --warning-text: #92400e;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --sidebar-bg: #1e293b;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background-color: var(--sidebar-bg);
            color: white;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo i {
            font-size: 1.5rem;
            color: var(--secondary-color);
        }

        .logo h2 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .county-badge {
            background: var(--primary-color);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 5px;
            display: inline-block;
        }

        .sidebar-user {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .user-info h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .user-role {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            display: block;
        }

        .sidebar-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .menu-section {
            margin-bottom: 30px;
        }

        .menu-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.5);
            padding: 0 20px;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            gap: 15px;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .menu-item.active {
            background-color: rgba(59, 130, 246, 0.2);
            color: white;
            border-left-color: var(--primary-color);
        }

        .menu-item i {
            width: 20px;
            text-align: center;
        }

        .menu-badge {
            margin-left: auto;
            background-color: var(--warning-color);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.online {
            background-color: var(--secondary-color);
            box-shadow: 0 0 10px var(--secondary-color);
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            min-height: 100vh;
        }

        /* Top Header */
        .top-header {
            padding: 20px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .header-left h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .county-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .header-btn:hover {
            background-color: var(--bg-color);
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-stats {
            display: flex;
            gap: 20px;
        }

        .quick-stat {
            text-align: center;
            padding: 10px 20px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .quick-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .quick-stat .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Dashboard Sections */
        .dashboard-sections {
            padding: 20px;
        }

        .dashboard-section {
            display: none;
        }

        .dashboard-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive {
            color: var(--secondary-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* Charts */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Data Tables */
        .data-table-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .table-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
        }

        .search-box input {
            border: none;
            background: none;
            color: var(--text-primary);
            width: 200px;
        }

        .search-box input:focus {
            outline: none;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: var(--bg-color);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table tr:hover {
            background-color: var(--bg-color);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: var(--warning-bg);
            color: var(--warning-text);
        }

        .status-approved {
            background-color: var(--success-bg);
            color: var(--success-text);
        }

        .status-rejected {
            background-color: var(--danger-bg);
            color: var(--danger-text);
        }

        .status-active {
            background-color: var(--success-bg);
            color: var(--success-text);
        }

        .status-overdue {
            background-color: var(--danger-bg);
            color: var(--danger-text);
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn.approve {
            background-color: var(--success-bg);
            color: var(--success-text);
        }

        .action-btn.reject {
            background-color: var(--danger-bg);
            color: var(--danger-text);
        }

        .action-btn.view {
            background-color: var(--info-color);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        /* Credit Score */
        .credit-score {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-bar {
            flex: 1;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            border-radius: 4px;
        }

        .score-fill.high {
            background-color: var(--secondary-color);
        }

        .score-fill.medium {
            background-color: var(--warning-color);
        }

        .score-fill.low {
            background-color: var(--danger-color);
        }

        /* Manager Grid */
        .manager-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .manager-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
        }

        .manager-card.vacant {
            border-color: var(--warning-color);
            background-color: rgba(245, 158, 11, 0.1);
        }

        .manager-card.occupied {
            border-color: var(--secondary-color);
        }

        .manager-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .manager-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .manager-info h4 {
            margin-bottom: 5px;
        }

        .manager-county {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .manager-contacts {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .contact-item i {
            width: 20px;
            color: var(--primary-color);
        }

        .vacant-label {
            background-color: var(--warning-color);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
            margin-top: 10px;
        }

        /* Modal */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background-color: var(--card-bg);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background-color: var(--success-bg);
            color: var(--success-text);
            border-left: 4px solid var(--secondary-color);
        }

        .alert-warning {
            background-color: var(--warning-bg);
            color: var(--warning-text);
            border-left: 4px solid var(--warning-color);
        }

        .alert-danger {
            background-color: var(--danger-bg);
            color: var(--danger-text);
            border-left: 4px solid var(--danger-color);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar-header h2,
            .user-info,
            .menu-section h3,
            .menu-item span,
            .status-item span:first-child {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .menu-item {
                justify-content: center;
                padding: 15px;
            }
            
            .header-left h1 {
                font-size: 1.2rem;
            }
            
            .quick-stats {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .section-actions {
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .manager-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Loading County Manager Dashboard</h2>
            <p>Loading your county data...</p>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-map-marked-alt"></i>
                <div>
                    <h2>County Manager</h2>
                    <span class="county-badge" id="countyName">Loading...</span>
                </div>
            </div>
        </div>

        <div class="sidebar-user">
            <div class="user-avatar">
                <i class="fas fa-user-tie"></i>
            </div>
            <div class="user-info">
                <h4 id="managerName">Manager</h4>
                <span class="user-role">County Manager</span>
            </div>
        </div>

        <div class="sidebar-menu">
            <div class="menu-section">
                <h3>DASHBOARD</h3>
                <div class="menu-item active" data-section="overview">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Overview</span>
                </div>
            </div>

            <div class="menu-section">
                <h3>LOAN MANAGEMENT</h3>
                <div class="menu-item" data-section="loan-approvals">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Loan Approvals</span>
                    <span class="menu-badge" id="pendingLoansCount">0</span>
                </div>
                <div class="menu-item" data-section="current-loans">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span>Current Loans</span>
                </div>
                <div class="menu-item" data-section="overdue-loans">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Overdue Loans</span>
                </div>
            </div>

            <div class="menu-section">
                <h3>CUSTOMER MANAGEMENT</h3>
                <div class="menu-item" data-section="customers">
                    <i class="fas fa-users"></i>
                    <span>Customers</span>
                </div>
                <div class="menu-item" data-section="guarantors">
                    <i class="fas fa-user-shield"></i>
                    <span>Guarantors</span>
                </div>
            </div>

            <div class="menu-section">
                <h3>STAFF MANAGEMENT</h3>
                <div class="menu-item" data-section="field-officers">
                    <i class="fas fa-user-friends"></i>
                    <span>Field Officers</span>
                </div>
                <div class="menu-item" data-section="hire-staff">
                    <i class="fas fa-user-plus"></i>
                    <span>Hire Staff</span>
                </div>
            </div>

            <div class="menu-section">
                <h3>NETWORK</h3>
                <div class="menu-item" data-section="other-managers">
                    <i class="fas fa-network-wired"></i>
                    <span>Other Managers</span>
                </div>
                <div class="menu-item" data-section="available-counties">
                    <i class="fas fa-map"></i>
                    <span>Available Counties</span>
                </div>
            </div>

            <div class="menu-section">
                <h3>SYSTEM</h3>
                <div class="menu-item" data-section="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </div>
                <div class="menu-item logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="status-item">
                <span>Connection</span>
                <span class="status-dot online" id="wsStatus"></span>
            </div>
            <div class="status-item">
                <span>Last Sync</span>
                <span id="lastSync">Just now</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <h1><i class="fas fa-chart-line"></i> County Performance Dashboard</h1>
                <div class="county-info" id="countyDetails">
                    <span id="constituencyCount">Loading constituencies...</span>
                    • 
                    <span id="fieldOfficerCount">Loading field officers...</span>
                </div>
            </div>

            <div class="header-right">
                <button class="header-btn" id="notificationBtn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-count" id="notificationCount">0</span>
                </button>
                <button class="header-btn" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="value" id="quickLoans">0</div>
                        <div class="label">Active Loans</div>
                    </div>
                    <div class="quick-stat">
                        <div class="value" id="quickOverdue">0</div>
                        <div class="label">Overdue</div>
                    </div>
                    <div class="quick-stat">
                        <div class="value" id="quickRepayment">0%</div>
                        <div class="label">Repayment Rate</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Sections -->
        <div class="dashboard-sections">
            <!-- Overview Section -->
            <section id="overviewSection" class="dashboard-section active">
                <div class="section-header">
                    <h2><i class="fas fa-tachometer-alt"></i> County Overview</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="dashboard.generateReport()">
                            <i class="fas fa-file-export"></i> Export Report
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Loans Disbursed</h3>
                        <div class="stat-value" id="totalLoans">KES 0</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 12% from last month
                        </div>
                    </div>

                    <div class="stat-card">
                        <h3>Active Customers</h3>
                        <div class="stat-value" id="activeCustomers">0</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 8% from last month
                        </div>
                    </div>

                    <div class="stat-card">
                        <h3>Field Officers</h3>
                        <div class="stat-value" id="totalFieldOfficers">0</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i> 2 new this month
                        </div>
                    </div>

                    <div class="stat-card">
                        <h3>Default Rate</h3>
                        <div class="stat-value" id="defaultRate">0%</div>
                        <div class="stat-change negative">
                            <i class="fas fa-arrow-down"></i> 1.2% from last month
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Loan Performance Trend</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Field Officer Performance</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="officerPerformanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Recent Loan Applications</h3>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Application ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Field Officer</th>
                                    <th>Applied Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentApplicationsTable">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Loan Approvals Section -->
            <section id="loanApprovalsSection" class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-clipboard-check"></i> Loan Approval Requests</h2>
                </div>

                <div id="approvalAlert" class="alert" style="display: none;"></div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Pending Loan Approvals</h3>
                        <div class="table-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="approvalSearch" placeholder="Search applications...">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Application ID</th>
                                    <th>Customer Details</th>
                                    <th>Loan Amount</th>
                                    <th>Purpose</th>
                                    <th>Field Officer</th>
                                    <th>Credit Score</th>
                                    <th>Guarantors</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="approvalsTableBody">
                                <!-- Approval requests will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Current Loans Section -->
            <section id="currentLoansSection" class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-hand-holding-usd"></i> Current Active Loans</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="dashboard.viewAllLoans()">
                            <i class="fas fa-list"></i> View All
                        </button>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Active Loans in Your County</h3>
                        <div class="table-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="loanSearch" placeholder="Search loans...">
                            </div>
                            <select id="loanFilter">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="near_due">Due Soon</option>
                                <option value="repaid">Partially Repaid</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Loan ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Disbursed</th>
                                    <th>Next Payment</th>
                                    <th>Remaining</th>
                                    <th>Field Officer</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="currentLoansTable">
                                <!-- Current loans will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Field Officers Section -->
            <section id="fieldOfficersSection" class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-user-friends"></i> Field Officer Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-success" onclick="dashboard.showHireForm()">
                            <i class="fas fa-user-plus"></i> Hire New Officer
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Field Officers</h3>
                        <div class="stat-value" id="officersCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Average Performance Score</h3>
                        <div class="stat-value" id="avgPerformance">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Top Performer</h3>
                        <div class="stat-value" id="topPerformer">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Loans Processed</h3>
                        <div class="stat-value" id="totalProcessed">0</div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Field Officers in Your County</h3>
                        <div class="table-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="officerSearch" placeholder="Search officers...">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>ID Number</th>
                                    <th>Phone</th>
                                    <th>Location</th>
                                    <th>Loans Processed</th>
                                    <th>Performance Score</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fieldOfficersTable">
                                <!-- Field officers will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Other Managers Section -->
            <section id="otherManagersSection" class="dashboard-section">
                <div class="section-header">
                    <h2><i class="fas fa-network-wired"></i> Other County Managers</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="dashboard.refreshManagers()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="manager-grid" id="managersGrid">
                    <!-- Manager cards will be populated here -->
                </div>
            </section>
        </div>
    </main>

    <!-- Modals -->
    <div id="modalContainer" class="modal-container"></div>

    <script>
        // Kenyan counties and constituencies
        const kenyanCounties = {
            'Nairobi': ['Westlands', 'Dagoretti North', 'Dagoretti South', 'Langata', 'Kibra', 'Roysambu', 'Kasarani', 'Ruaraka', 'Embakasi South', 'Embakasi North', 'Embakasi Central', 'Embakasi East', 'Embakasi West', 'Makadara', 'Kamukunji', 'Starehe', 'Mathare'],
            'Mombasa': ['Changamwe', 'Jomvu', 'Kisauni', 'Nyali', 'Likoni', 'Mvita'],
            'Kisumu': ['Kisumu Central', 'Kisumu East', 'Kisumu West', 'Seme', 'Nyando', 'Muhoroni', 'Nyakach'],
            'Nakuru': ['Nakuru Town East', 'Nakuru Town West', 'Molo', 'Njoro', 'Naivasha', 'Gilgil', 'Kuresoi South', 'Kuresoi North', 'Subukia', 'Rongai', 'Bahati'],
            'Kisii': ['Kitutu Chache North', 'Kitutu Chache South', 'Nyaribari Chache', 'Nyaribari Masaba', 'Bomachoge Borabu', 'Bomachoge Chache', 'Bobasi', 'Bomachoge', 'South Mugirango', 'North Mugirango'],
            'Meru': ['South Imenti', 'North Imenti', 'Tigania West', 'Tigania East', 'Igembe South', 'Igembe Central', 'Igembe North', 'Buuri'],
            'Kiambu': ['Gatundu South', 'Gatundu North', 'Juja', 'Thika Town', 'Ruiru', 'Githunguri', 'Kiambu', 'Kiambaa', 'Kabete', 'Kikuyu', 'Limuru', 'Lari']
        };

        class ManagerDashboard {
            constructor() {
                this.currentCounty = '';
                this.managerData = {};
                this.data = {
                    loanApplications: [],
                    currentLoans: [],
                    fieldOfficers: [],
                    customers: [],
                    guarantors: [],
                    otherManagers: [],
                    notifications: []
                };
                
                this.init();
            }

            async init() {
                // Check authentication
                await this.checkAuthentication();
                
                // Initialize components
                this.initializeComponents();
                
                // Load data
                await this.loadInitialData();
                
                // Initialize WebSocket
                this.initializeWebSocket();
                
                // Hide loading screen
                this.hideLoadingScreen();
                
                // Start real-time updates
                this.startRealTimeUpdates();
            }

            async checkAuthentication() {
                const session = JSON.parse(localStorage.getItem('mfk_session') || '{}');
                const users = JSON.parse(localStorage.getItem('mfk_users') || '[]');
                
                // Check if user is manager
                const user = users.find(u => u.id === session.id);
                
                if (!user || user.role !== 'manager' || user.status !== 'approved') {
                    window.location.href = 'login.html';
                    return;
                }
                
                this.managerData = user;
                this.currentCounty = user.county;
                
                // Update UI
                document.getElementById('managerName').textContent = user.fullName;
                document.getElementById('countyName').textContent = this.formatCountyName(user.county);
                
                // Get county details
                this.loadCountyDetails();
            }

            initializeComponents() {
                this.setupEventListeners();
                this.initializeCharts();
            }

            setupEventListeners() {
                // Sidebar navigation
                document.querySelectorAll('.menu-item').forEach(item => {
                    if (!item.classList.contains('logout')) {
                        item.addEventListener('click', (e) => {
                            const section = item.getAttribute('data-section').replace('-', '');
                            this.switchSection(section);
                            
                            // Update active state
                            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                            item.classList.add('active');
                        });
                    }
                });

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.logout();
                });

                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });

                // Search functionality
                document.getElementById('approvalSearch')?.addEventListener('input', (e) => {
                    this.searchApplications(e.target.value);
                });

                document.getElementById('loanSearch')?.addEventListener('input', (e) => {
                    this.searchLoans(e.target.value);
                });

                document.getElementById('officerSearch')?.addEventListener('input', (e) => {
                    this.searchOfficers(e.target.value);
                });
            }

            async loadInitialData() {
                try {
                    // Load mock data
                    this.data.loanApplications = this.generateMockApplications();
                    this.data.currentLoans = this.generateMockCurrentLoans();
                    this.data.fieldOfficers = this.generateMockFieldOfficers();
                    this.data.customers = this.generateMockCustomers();
                    this.data.guarantors = this.generateMockGuarantors();
                    this.data.otherManagers = this.generateMockOtherManagers();
                    
                    // Update UI
                    this.updateDashboardStats();
                    this.renderApprovalsTable();
                    this.renderCurrentLoansTable();
                    this.renderFieldOfficersTable();
                    this.renderOtherManagers();
                    
                    // Update notification count
                    this.updateNotificationCount();
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showAlert('Failed to load data', 'error');
                }
            }

            loadCountyDetails() {
                const countyName = this.formatCountyName(this.currentCounty);
                const constituencies = kenyanCounties[countyName] || [];
                
                // Update county info
                document.getElementById('countyDetails').innerHTML = `
                    <span id="constituencyCount">${constituencies.length} constituencies</span>
                    • 
                    <span id="fieldOfficerCount">${this.data.fieldOfficers.length} field officers</span>
                `;
            }

            generateMockApplications() {
                const applications = [];
                const purposes = [
                    'Business Expansion',
                    'Agricultural Investment',
                    'Education Fees',
                    'Medical Expenses',
                    'Home Improvement',
                    'Vehicle Purchase'
                ];
                
                for (let i = 1; i <= 15; i++) {
                    const amount = Math.floor(Math.random() * 500000) + 50000;
                    const creditScore = Math.floor(Math.random() * 300) + 500;
                    
                    applications.push({
                        id: `APP-${String(i).padStart(5, '0')}`,
                        customerName: `Customer ${i}`,
                        customerId: `CUST-${String(i).padStart(5, '0')}`,
                        amount: amount,
                        purpose: purposes[Math.floor(Math.random() * purposes.length)],
                        fieldOfficer: `Officer ${Math.floor(Math.random() * 10) + 1}`,
                        creditScore: creditScore,
                        guarantors: Math.floor(Math.random() * 3) + 1,
                        appliedDate: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                        status: 'pending',
                        constituency: kenyanCounties[this.formatCountyName(this.currentCounty)]?.[Math.floor(Math.random() * kenyanCounties[this.formatCountyName(this.currentCounty)].length)] || 'Unknown'
                    });
                }
                return applications;
            }

            generateMockCurrentLoans() {
                const loans = [];
                const statuses = ['active', 'near_due', 'repaid_partial'];
                
                for (let i = 1; i <= 25; i++) {
                    const amount = Math.floor(Math.random() * 500000) + 50000;
                    const disbursed = Math.floor(Math.random() * amount);
                    const remaining = amount - disbursed;
                    
                    loans.push({
                        id: `LOAN-${String(i).padStart(5, '0')}`,
                        customerName: `Customer ${i}`,
                        customerId: `CUST-${String(i).padStart(5, '0')}`,
                        amount: amount,
                        disbursed: disbursed,
                        remaining: remaining,
                        nextPayment: new Date(Date.now() + Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                        fieldOfficer: `Officer ${Math.floor(Math.random() * 10) + 1}`,
                        status: statuses[Math.floor(Math.random() * statuses.length)],
                        startDate: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toLocaleDateString()
                    });
                }
                return loans;
            }

            generateMockFieldOfficers() {
                const officers = [];
                
                for (let i = 1; i <= 8; i++) {
                    const performanceScore = Math.floor(Math.random() * 100);
                    
                    officers.push({
                        id: `OFFICER-${String(i).padStart(5, '0')}`,
                        name: `John Doe ${i}`,
                        nationalId: `${Math.floor(Math.random() * 90000000) + 10000000}`,
                        phone: `+2547${Math.floor(Math.random() * 9000000) + 1000000}`,
                        location: `Location ${i}, ${this.formatCountyName(this.currentCounty)}`,
                        residence: `Estate ${i}, ${this.formatCountyName(this.currentCounty)}`,
                        loansProcessed: Math.floor(Math.random() * 50) + 10,
                        performanceScore: performanceScore,
                        status: 'active',
                        hireDate: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                        email: `officer${i}@microfinance.co.ke`
                    });
                }
                return officers;
            }

            generateMockOtherManagers() {
                const managers = [];
                const counties = Object.keys(kenyanCounties);
                
                // Current manager
                managers.push({
                    name: this.managerData.fullName,
                    county: this.formatCountyName(this.currentCounty),
                    email: this.managerData.email,
                    phone: this.managerData.phone,
                    status: 'active',
                    isCurrent: true
                });
                
                // Other managers (some vacancies)
                counties.forEach(county => {
                    if (county !== this.formatCountyName(this.currentCounty)) {
                        const hasManager = Math.random() > 0.3; // 70% chance of having manager
                        
                        if (hasManager) {
                            managers.push({
                                name: `Manager ${county}`,
                                county: county,
                                email: `manager.${county.toLowerCase().replace(' ', '')}@microfinance.co.ke`,
                                phone: `+2547${Math.floor(Math.random() * 9000000) + 1000000}`,
                                status: 'active',
                                isCurrent: false
                            });
                        } else {
                            managers.push({
                                name: 'Vacant Position',
                                county: county,
                                email: 'admin@microfinance.co.ke',
                                phone: '+254700000000',
                                status: 'vacant',
                                isCurrent: false
                            });
                        }
                    }
                });
                
                return managers;
            }

            updateDashboardStats() {
                // Calculate stats
                const totalLoans = this.data.currentLoans.reduce((sum, loan) => sum + loan.amount, 0);
                const activeCustomers = new Set(this.data.currentLoans.map(loan => loan.customerId)).size;
                const overdueLoans = this.data.currentLoans.filter(loan => loan.status === 'near_due').length;
                const defaultRate = Math.floor(Math.random() * 10) + 1; // Mock
                const repaymentRate = 100 - defaultRate;
                
                // Field officer stats
                const officersCount = this.data.fieldOfficers.length;
                const avgPerformance = officersCount > 0 ? 
                    Math.round(this.data.fieldOfficers.reduce((sum, o) => sum + o.performanceScore, 0) / officersCount) : 0;
                
                const topOfficer = this.data.fieldOfficers.reduce((top, current) => 
                    current.performanceScore > top.performanceScore ? current : top, 
                    { name: '-', performanceScore: 0 }
                );
                
                const totalProcessed = this.data.fieldOfficers.reduce((sum, o) => sum + o.loansProcessed, 0);
                
                // Update UI
                document.getElementById('totalLoans').textContent = `KES ${totalLoans.toLocaleString()}`;
                document.getElementById('activeCustomers').textContent = activeCustomers.toLocaleString();
                document.getElementById('totalFieldOfficers').textContent = officersCount.toLocaleString();
                document.getElementById('defaultRate').textContent = `${defaultRate}%`;
                
                document.getElementById('quickLoans').textContent = this.data.currentLoans.length;
                document.getElementById('quickOverdue').textContent = overdueLoans;
                document.getElementById('quickRepayment').textContent = `${repaymentRate}%`;
                
                document.getElementById('officersCount').textContent = officersCount;
                document.getElementById('avgPerformance').textContent = avgPerformance;
                document.getElementById('topPerformer').textContent = topOfficer.name.split(' ')[0];
                document.getElementById('totalProcessed').textContent = totalProcessed;
                
                // Update pending loans count
                const pendingLoans = this.data.loanApplications.filter(app => app.status === 'pending').length;
                document.getElementById('pendingLoansCount').textContent = pendingLoans;
            }

            renderApprovalsTable() {
                const tableBody = document.getElementById('approvalsTableBody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                const pendingApplications = this.data.loanApplications.filter(app => app.status === 'pending');
                
                pendingApplications.forEach(app => {
                    const row = document.createElement('tr');
                    
                    // Credit score indicator
                    let scoreClass = '';
                    if (app.creditScore >= 700) scoreClass = 'high';
                    else if (app.creditScore >= 500) scoreClass = 'medium';
                    else scoreClass = 'low';
                    
                    row.innerHTML = `
                        <td>${app.id}</td>
                        <td>
                            <strong>${app.customerName}</strong><br>
                            <small>${app.constituency}</small>
                        </td>
                        <td>KES ${app.amount.toLocaleString()}</td>
                        <td>${app.purpose}</td>
                        <td>${app.fieldOfficer}</td>
                        <td>
                            <div class="credit-score">
                                <div class="score-bar">
                                    <div class="score-fill ${scoreClass}" style="width: ${(app.creditScore / 800) * 100}%"></div>
                                </div>
                                <span>${app.creditScore}</span>
                            </div>
                        </td>
                        <td>${app.guarantors} guarantor(s)</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="dashboard.viewApplication('${app.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn approve" onclick="dashboard.approveLoan('${app.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="action-btn reject" onclick="dashboard.rejectLoan('${app.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }

            renderCurrentLoansTable() {
                const tableBody = document.getElementById('currentLoansTable');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                this.data.currentLoans.forEach(loan => {
                    const row = document.createElement('tr');
                    
                    // Status badge
                    let statusClass = '';
                    let statusText = '';
                    switch(loan.status) {
                        case 'active':
                            statusClass = 'status-active';
                            statusText = 'Active';
                            break;
                        case 'near_due':
                            statusClass = 'status-overdue';
                            statusText = 'Due Soon';
                            break;
                        case 'repaid_partial':
                            statusClass = 'status-pending';
                            statusText = 'Partially Paid';
                            break;
                    }
                    
                    // Progress calculation
                    const progress = ((loan.disbursed - loan.remaining) / loan.disbursed * 100).toFixed(1);
                    
                    row.innerHTML = `
                        <td>${loan.id}</td>
                        <td>${loan.customerName}</td>
                        <td>KES ${loan.amount.toLocaleString()}</td>
                        <td>${loan.startDate}</td>
                        <td><strong>${loan.nextPayment}</strong></td>
                        <td>KES ${loan.remaining.toLocaleString()} (${progress}%)</td>
                        <td>${loan.fieldOfficer}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="dashboard.viewLoanDetails('${loan.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="dashboard.sendReminder('${loan.id}')">
                                    <i class="fas fa-bell"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }

            renderFieldOfficersTable() {
                const tableBody = document.getElementById('fieldOfficersTable');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                this.data.fieldOfficers.forEach(officer => {
                    const row = document.createElement('tr');
                    
                    // Performance stars
                    const score = officer.performanceScore;
                    const stars = Math.ceil(score / 20); // 5-star scale
                    const starHtml = '<i class="fas fa-star"></i>'.repeat(stars);
                    
                    row.innerHTML = `
                        <td>${officer.name}</td>
                        <td>${officer.nationalId}</td>
                        <td>${officer.phone}</td>
                        <td>${officer.location}</td>
                        <td>${officer.loansProcessed}</td>
                        <td>
                            <div>${starHtml}</div>
                            <small>Score: ${score}</small>
                        </td>
                        <td><span class="status-badge status-active">Active</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="dashboard.viewOfficerDetails('${officer.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="dashboard.editOfficer('${officer.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn reject" onclick="dashboard.terminateOfficer('${officer.id}')">
                                    <i class="fas fa-user-slash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }

            renderOtherManagers() {
                const grid = document.getElementById('managersGrid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                this.data.otherManagers.forEach(manager => {
                    const card = document.createElement('div');
                    card.className = `manager-card ${manager.status === 'vacant' ? 'vacant' : 'occupied'}`;
                    
                    if (manager.isCurrent) {
                        card.innerHTML = `
                            <div class="manager-header">
                                <div class="manager-avatar">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div class="manager-info">
                                    <h4>${manager.name} (You)</h4>
                                    <div class="manager-county">${manager.county} County</div>
                                </div>
                            </div>
                            <div class="manager-contacts">
                                <div class="contact-item">
                                    <i class="fas fa-envelope"></i>
                                    <span>${manager.email}</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-phone"></i>
                                    <span>${manager.phone}</span>
                                </div>
                            </div>
                        `;
                    } else if (manager.status === 'vacant') {
                        card.innerHTML = `
                            <div class="manager-header">
                                <div class="manager-avatar">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="manager-info">
                                    <h4>Position Available</h4>
                                    <div class="manager-county">${manager.county} County</div>
                                </div>
                            </div>
                            <p>This county currently has no manager. Contact admin to apply.</p>
                            <div class="manager-contacts">
                                <div class="contact-item">
                                    <i class="fas fa-envelope"></i>
                                    <span>${manager.email}</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-phone"></i>
                                    <span>${manager.phone}</span>
                                </div>
                            </div>
                            <div class="vacant-label">Position Vacant</div>
                        `;
                    } else {
                        card.innerHTML = `
                            <div class="manager-header">
                                <div class="manager-avatar">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <div class="manager-info">
                                    <h4>${manager.name}</h4>
                                    <div class="manager-county">${manager.county} County</div>
                                </div>
                            </div>
                            <div class="manager-contacts">
                                <div class="contact-item">
                                    <i class="fas fa-envelope"></i>
                                    <span>${manager.email}</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-phone"></i>
                                    <span>${manager.phone}</span>
                                </div>
                            </div>
                            <button class="btn btn-primary" style="margin-top: 15px; width: 100%;" 
                                    onclick="dashboard.contactManager('${manager.email}', '${manager.county}')">
                                <i class="fas fa-comment"></i> Contact Manager
                            </button>
                        `;
                    }
                    
                    grid.appendChild(card);
                });
            }

            initializeCharts() {
                // Performance Chart
                const performanceCtx = document.getElementById('performanceChart').getContext('2d');
                this.performanceChart = new Chart(performanceCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Loans Disbursed (KES)',
                            data: [2500000, 3200000, 2800000, 4100000, 3900000, 4500000],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true
                        }, {
                            label: 'Repayments (KES)',
                            data: [2000000, 2800000, 2400000, 3500000, 3200000, 4000000],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });

                // Officer Performance Chart
                const officerCtx = document.getElementById('officerPerformanceChart').getContext('2d');
                this.officerChart = new Chart(officerCtx, {
                    type: 'bar',
                    data: {
                        labels: this.data.fieldOfficers.slice(0, 5).map(o => o.name.split(' ')[0]),
                        datasets: [{
                            label: 'Performance Score',
                            data: this.data.fieldOfficers.slice(0, 5).map(o => o.performanceScore),
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.7)',
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(245, 158, 11, 0.7)',
                                'rgba(139, 92, 246, 0.7)',
                                'rgba(239, 68, 68, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }

            initializeWebSocket() {
                // Simulate WebSocket connection
                this.socket = {
                    connected: true,
                    emit: (event, data) => {
                        console.log('WebSocket emit:', event, data);
                    }
                };

                this.updateConnectionStatus(true);
            }

            updateConnectionStatus(connected) {
                const wsStatus = document.getElementById('wsStatus');
                if (wsStatus) {
                    wsStatus.style.backgroundColor = connected ? '#10b981' : '#ef4444';
                    wsStatus.style.boxShadow = connected ? '0 0 10px #10b981' : 'none';
                }
            }

            switchSection(section) {
                // Hide all sections
                document.querySelectorAll('.dashboard-section').forEach(s => {
                    s.classList.remove('active');
                });
                
                // Show selected section
                const sectionEl = document.getElementById(`${section}Section`);
                if (sectionEl) {
                    sectionEl.classList.add('active');
                    
                    // Load section-specific data if needed
                    switch(section) {
                        case 'otheromanagers':
                            this.renderOtherManagers();
                            break;
                    }
                }
            }

            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                const icon = document.querySelector('#themeToggle i');
                icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }

            // Loan Approval Methods
            viewApplication(appId) {
                const application = this.data.loanApplications.find(app => app.id === appId);
                if (application) {
                    this.showApplicationModal(application);
                }
            }

            approveLoan(appId) {
                if (confirm('Are you sure you want to approve this loan application?')) {
                    const application = this.data.loanApplications.find(app => app.id === appId);
                    if (application) {
                        application.status = 'approved';
                        application.approvedBy = this.managerData.fullName;
                        application.approvedDate = new Date().toLocaleDateString();
                        
                        // Show success message
                        this.showAlert(`Loan ${appId} approved successfully!`, 'success', 'approvalAlert');
                        
                        // Update table
                        this.renderApprovalsTable();
                        this.updateDashboardStats();
                        
                        // Log activity
                        this.logActivity('loan_approved', `Approved loan application ${appId} for ${application.customerName}`);
                        
                        // Send notification
                        this.addNotification({
                            type: 'success',
                            title: 'Loan Approved',
                            message: `Loan ${appId} has been approved`,
                            timestamp: new Date()
                        });
                    }
                }
            }

            rejectLoan(appId) {
                if (confirm('Are you sure you want to reject this loan application?')) {
                    const application = this.data.loanApplications.find(app => app.id === appId);
                    if (application) {
                        application.status = 'rejected';
                        application.rejectedBy = this.managerData.fullName;
                        application.rejectedDate = new Date().toLocaleDateString();
                        
                        // Show message
                        this.showAlert(`Loan ${appId} has been rejected.`, 'warning', 'approvalAlert');
                        
                        // Update table
                        this.renderApprovalsTable();
                        
                        // Log activity
                        this.logActivity('loan_rejected', `Rejected loan application ${appId} for ${application.customerName}`);
                    }
                }
            }

            // Field Officer Management
            showHireForm() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-header">
                        <h3>Hire New Field Officer</h3>
                        <button class="modal-close" onclick="dashboard.closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="hireForm">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="officerName" required>
                            </div>
                            <div class="form-group">
                                <label>National ID Number</label>
                                <input type="text" id="officerId" required pattern="\\d{8}">
                            </div>
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" id="officerPhone" required pattern="^\\+2547\\d{8}$">
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" id="officerEmail" required>
                            </div>
                            <div class="form-group">
                                <label>Residential Address</label>
                                <textarea id="officerResidence" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label>Location/Constituency</label>
                                <select id="officerLocation" required>
                                    <option value="">Select Constituency</option>
                                    ${kenyanCounties[this.formatCountyName(this.currentCounty)]?.map(c => 
                                        `<option value="${c}">${c}</option>`
                                    ).join('') || ''}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Monthly Salary (KES)</label>
                                <input type="number" id="officerSalary" required min="15000" step="1000">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="dashboard.closeModal()">Cancel</button>
                        <button class="btn btn-success" onclick="dashboard.submitHireForm()">Hire Officer</button>
                    </div>
                `;
                
                document.getElementById('modalContainer').appendChild(modal);
                document.getElementById('modalContainer').style.display = 'flex';
            }

            submitHireForm() {
                // Get form values
                const name = document.getElementById('officerName').value.trim();
                const nationalId = document.getElementById('officerId').value.trim();
                const phone = document.getElementById('officerPhone').value.trim();
                const email = document.getElementById('officerEmail').value.trim();
                const residence = document.getElementById('officerResidence').value.trim();
                const location = document.getElementById('officerLocation').value;
                const salary = parseInt(document.getElementById('officerSalary').value);
                
                // Validation
                if (!name || !nationalId || !phone || !email || !residence || !location || !salary) {
                    this.showAlert('Please fill all fields', 'error');
                    return;
                }
                
                // Create new officer
                const newOfficer = {
                    id: `OFFICER-${String(this.data.fieldOfficers.length + 1).padStart(5, '0')}`,
                    name: name,
                    nationalId: nationalId,
                    phone: phone,
                    email: email,
                    location: `${location}, ${this.formatCountyName(this.currentCounty)}`,
                    residence: residence,
                    loansProcessed: 0,
                    performanceScore: 50, // Starting score
                    status: 'active',
                    salary: salary,
                    hireDate: new Date().toLocaleDateString()
                };
                
                // Add to data
                this.data.fieldOfficers.push(newOfficer);
                
                // Update UI
                this.updateDashboardStats();
                this.renderFieldOfficersTable();
                this.updateCharts();
                
                // Close modal
                this.closeModal();
                
                // Show success message
                this.showAlert(`${name} has been hired successfully!`, 'success');
                
                // Log activity
                this.logActivity('officer_hired', `Hired new field officer: ${name}`);
            }

            viewOfficerDetails(officerId) {
                const officer = this.data.fieldOfficers.find(o => o.id === officerId);
                if (officer) {
                    this.showOfficerDetailsModal(officer);
                }
            }

            terminateOfficer(officerId) {
                if (confirm('Are you sure you want to terminate this field officer?')) {
                    const officer = this.data.fieldOfficers.find(o => o.id === officerId);
                    if (officer) {
                        officer.status = 'terminated';
                        officer.terminationDate = new Date().toLocaleDateString();
                        
                        // Update table
                        this.renderFieldOfficersTable();
                        this.updateDashboardStats();
                        
                        this.showAlert(`${officer.name} has been terminated.`, 'warning');
                        this.logActivity('officer_terminated', `Terminated field officer: ${officer.name}`);
                    }
                }
            }

            // Other Methods
            contactManager(email, county) {
                const subject = `Contact from ${this.managerData.fullName} - ${this.formatCountyName(this.currentCounty)} County`;
                const body = `Dear Manager,\n\nI am reaching out from ${this.formatCountyName(this.currentCounty)} County.`;
                
                // In a real app, this would open email client
                alert(`Would open email to: ${email}\nSubject: ${subject}`);
            }

            viewLoanDetails(loanId) {
                const loan = this.data.currentLoans.find(l => l.id === loanId);
                if (loan) {
                    this.showLoanDetailsModal(loan);
                }
            }

            sendReminder(loanId) {
                const loan = this.data.currentLoans.find(l => l.id === loanId);
                if (loan) {
                    // Simulate sending reminder
                    this.showAlert(`Payment reminder sent to ${loan.customerName}`, 'success');
                    this.logActivity('reminder_sent', `Sent payment reminder for loan ${loanId}`);
                }
            }

            generateReport() {
                const reportData = {
                    county: this.formatCountyName(this.currentCounty),
                    manager: this.managerData.fullName,
                    generated: new Date().toLocaleDateString(),
                    stats: {
                        totalLoans: this.data.currentLoans.length,
                        totalAmount: this.data.currentLoans.reduce((sum, l) => sum + l.amount, 0),
                        fieldOfficers: this.data.fieldOfficers.length,
                        pendingApplications: this.data.loanApplications.filter(a => a.status === 'pending').length
                    },
                    topOfficers: this.data.fieldOfficers
                        .sort((a, b) => b.performanceScore - a.performanceScore)
                        .slice(0, 5)
                };
                
                const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `county-report-${this.currentCounty}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showAlert('Report generated successfully', 'success');
            }

            refreshManagers() {
                this.data.otherManagers = this.generateMockOtherManagers();
                this.renderOtherManagers();
                this.showAlert('Manager list refreshed', 'success');
            }

            searchApplications(searchTerm) {
                const filtered = this.data.loanApplications.filter(app => 
                    app.status === 'pending' && (
                        app.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        app.customerName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        app.fieldOfficer.toLowerCase().includes(searchTerm.toLowerCase())
                    )
                );
                
                this.renderFilteredApplications(filtered);
            }

            searchLoans(searchTerm) {
                const filtered = this.data.currentLoans.filter(loan => 
                    loan.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    loan.customerName.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                this.renderFilteredLoans(filtered);
            }

            searchOfficers(searchTerm) {
                const filtered = this.data.fieldOfficers.filter(officer => 
                    officer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    officer.nationalId.includes(searchTerm) ||
                    officer.location.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                this.renderFilteredOfficers(filtered);
            }

            renderFilteredApplications(applications) {
                const tableBody = document.getElementById('approvalsTableBody');
                if (!tableBody) return;
                
                tableBody.innerHTML = '';
                
                applications.forEach(app => {
                    // Same as renderApprovalsTable but only for filtered
                    const row = document.createElement('tr');
                    // ... (similar to renderApprovalsTable)
                    tableBody.appendChild(row);
                });
            }

            updateNotificationCount() {
                const pendingLoans = this.data.loanApplications.filter(app => app.status === 'pending').length;
                const overdueLoans = this.data.currentLoans.filter(loan => loan.status === 'near_due').length;
                const total = pendingLoans + overdueLoans;
                
                document.getElementById('notificationCount').textContent = total;
                document.getElementById('notificationCount').style.display = total > 0 ? 'flex' : 'none';
            }

            addNotification(notification) {
                this.data.notifications.unshift(notification);
                this.updateNotificationCount();
            }

            updateCharts() {
                if (this.performanceChart && this.officerChart) {
                    this.performanceChart.update();
                    this.officerChart.update();
                }
            }

            closeModal() {
                const container = document.getElementById('modalContainer');
                container.style.display = 'none';
                container.innerHTML = '';
            }

            showAlert(message, type = 'info', containerId = null) {
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                `;

                if (containerId) {
                    const container = document.getElementById(containerId);
                    container.innerHTML = '';
                    container.appendChild(alert);
                    container.style.display = 'block';
                } else {
                    Object.assign(alert.style, {
                        position: 'fixed',
                        top: '20px',
                        right: '20px',
                        padding: '15px 20px',
                        borderRadius: '8px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '10px',
                        zIndex: '1000',
                        color: 'white',
                        minWidth: '300px',
                        boxShadow: '0 5px 15px rgba(0,0,0,0.2)',
                        animation: 'slideIn 0.3s ease'
                    });

                    if (type === 'success') {
                        alert.style.backgroundColor = '#10b981';
                    } else if (type === 'error') {
                        alert.style.backgroundColor = '#ef4444';
                    } else if (type === 'warning') {
                        alert.style.backgroundColor = '#f59e0b';
                    } else {
                        alert.style.backgroundColor = '#3b82f6';
                    }

                    document.body.appendChild(alert);

                    // Auto remove after 5 seconds
                    setTimeout(() => {
                        alert.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => alert.remove(), 300);
                    }, 5000);
                }
            }

            logActivity(action, details) {
                const activities = JSON.parse(localStorage.getItem('mfk_activities') || '[]');
                activities.push({
                    timestamp: new Date().toISOString(),
                    action,
                    details,
                    user: this.managerData.fullName,
                    role: 'manager',
                    county: this.formatCountyName(this.currentCounty)
                });
                localStorage.setItem('mfk_activities', JSON.stringify(activities.slice(-1000)));
            }

            hideLoadingScreen() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 300);
                }
            }

            logout() {
                localStorage.removeItem('mfk_session');
                window.location.href = 'login.html';
            }

            startRealTimeUpdates() {
                // Update last sync time
                setInterval(() => {
                    document.getElementById('lastSync').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }, 60000);
            }

            formatCountyName(countyCode) {
                return countyCode.split('-').map(word => 
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            const session = JSON.parse(localStorage.getItem('mfk_session') || '{}');
            if (!session.id) {
                window.location.href = 'login.html';
                return;
            }
            
            window.dashboard = new ManagerDashboard();
        });

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>